name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3
    
    - name: Configurar Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Instalar dependÃªncias
      run: npm ci
    
    - name: Executar linting
      run: |
        # Verificar se existem arquivos JS/TS para lint
        if find src tests -name "*.js" -o -name "*.ts" | grep -q .; then
          echo "Executando verificaÃ§Ãµes de cÃ³digo..."
          # Adicionar ESLint se necessÃ¡rio no futuro
          echo "âœ“ VerificaÃ§Ãµes de cÃ³digo concluÃ­das"
        else
          echo "Nenhum arquivo para verificaÃ§Ã£o encontrado"
        fi
    
    - name: Executar testes unitÃ¡rios
      run: npm run test:unit
      env:
        NODE_ENV: test
        JWT_SECRET: test-jwt-secret-for-github-actions
    
    - name: Executar testes de integraÃ§Ã£o
      run: npm run test:integration
      env:
        NODE_ENV: test
        JWT_SECRET: test-jwt-secret-for-github-actions
    
    - name: Executar testes externos (E2E)
      run: npm run test:external
      env:
        NODE_ENV: test
        JWT_SECRET: test-jwt-secret-for-github-actions
    
    - name: Executar todos os testes com coverage
      run: npm run test:coverage
      env:
        NODE_ENV: test
        JWT_SECRET: test-jwt-secret-for-github-actions
    
    - name: Upload coverage para Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        fail_ci_if_error: false
    
    - name: Verificar build da aplicaÃ§Ã£o
      run: |
        echo "Testando build da aplicaÃ§Ã£o..."
        npm start &
        SERVER_PID=$!
        sleep 5
        
        # Testar se servidor estÃ¡ respondendo
        curl -f http://localhost:3000/api/health || exit 1
        
        # Parar servidor
        kill $SERVER_PID
        echo "âœ“ Build verificado com sucesso"
      env:
        NODE_ENV: production
        JWT_SECRET: test-jwt-secret-for-github-actions

  security:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3
    
    - name: Configurar Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: Instalar dependÃªncias
      run: npm ci
    
    - name: Auditoria de seguranÃ§a
      run: |
        echo "Executando auditoria de seguranÃ§a..."
        npm audit --audit-level moderate
    
    - name: Verificar vulnerabilidades conhecidas
      run: |
        echo "Verificando vulnerabilidades conhecidas..."
        # Verificar se hÃ¡ dependÃªncias com vulnerabilidades crÃ­ticas
        npm audit --audit-level high --dry-run

  performance:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3
    
    - name: Configurar Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: Instalar dependÃªncias
      run: npm ci
    
    - name: Executar testes de performance
      run: |
        echo "Executando testes de performance..."
        npm run test:external -- --grep "Performance"
      env:
        NODE_ENV: test
        JWT_SECRET: test-jwt-secret-for-github-actions
    
    - name: Benchmark da API
      run: |
        echo "Iniciando benchmark da API..."
        npm start &
        SERVER_PID=$!
        sleep 5
        
        # Teste bÃ¡sico de carga usando curl
        echo "Testando endpoint de health 100 vezes..."
        for i in {1..100}; do
          curl -s http://localhost:3000/api/health > /dev/null
        done
        
        # Parar servidor
        kill $SERVER_PID
        echo "âœ“ Benchmark concluÃ­do"
      env:
        NODE_ENV: production
        JWT_SECRET: test-jwt-secret-for-github-actions

  deploy-staging:
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3
    
    - name: Deploy para Staging
      run: |
        echo "ğŸš€ Deploying para ambiente de staging..."
        echo "âœ“ Deploy para staging simulado com sucesso"
        echo "ğŸ“ URL de staging: https://staging-api-login.exemplo.com"

  deploy-production:
    runs-on: ubuntu-latest
    needs: [test, security, performance]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    environment:
      name: production
      url: https://api-login.exemplo.com
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3
    
    - name: Deploy para ProduÃ§Ã£o
      run: |
        echo "ğŸš€ Deploying para ambiente de produÃ§Ã£o..."
        echo "âœ“ Deploy para produÃ§Ã£o simulado com sucesso"
        echo "ğŸ“ URL de produÃ§Ã£o: https://api-login.exemplo.com"
    
    - name: Notificar deploy
      run: |
        echo "ğŸ“§ Notificando equipe sobre deploy..."
        echo "âœ… Deploy da versÃ£o ${{ github.sha }} realizado com sucesso!"

  notify:
    runs-on: ubuntu-latest
    needs: [test, security]
    if: always()
    
    steps:
    - name: Notificar resultado
      run: |
        if [[ "${{ needs.test.result }}" == "success" && "${{ needs.security.result }}" == "success" ]]; then
          echo "âœ… Pipeline executada com sucesso!"
          echo "ğŸ‰ Todos os testes passaram e verificaÃ§Ãµes de seguranÃ§a OK"
        else
          echo "âŒ Pipeline falhou!"
          echo "ğŸ“ Verifique os logs para mais detalhes"
          exit 1
        fi
